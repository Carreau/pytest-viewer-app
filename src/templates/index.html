<!DOCTYPE html>
<!--
Generic treemap, based on http://bost.ocks.org/mike/treemap/

-->
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pytest Json-report viewer {{org}}/{{repo}}/{{number}}</title>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic"
    />

    <!-- CSS Reset -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css"
    />

    <!-- Milligram CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        height: 100vh;
        background-color: #e5e5e5;
        display: flex;  
        flex-direction: column;
      }

      footer {
   margin-top: auto;
        }

      #chart {
        background: #fff;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin-left: 10px;
        margin-right: 10px;
      }

      .title {
        font-weight: bold;
        font-size: 24px;
        text-align: center;
        margin-top: 6px;
        margin-bottom: 6px;
      }

      text {
        pointer-events: none;
      }

      #infowrap {
        background: var(--form-back-color);
        margin-left: 8px;
        margin-right: 16px;
        padding: 8px;
        padding-left: 18px;
        padding-right: 18px;
        margin-top: 10px;
      }

      content {
        margin: 50px;
        border: solid thin darkgray;
        padding: 50px;
        display: block;
        background: lightgrey;
        text-align: center;
      }

      .grandparent text {
        font-weight: bold;
      }

      rect {
        fill: none;
        stroke: #fff;
      }

      rect.parent,
      .grandparent rect {
        stroke-width: 2px;
      }

      rect.parent {
        pointer-events: none;
      }

      .grandparent rect {
        fill: orange;
      }

      .grandparent:hover rect {
        fill: #ee9700;
      }

      .children rect.parent,
      .grandparent rect {
        cursor: pointer;
      }

      .children rect.parent {
        fill: #bbb;
        fill-opacity: 0.5;
      }

      .children:hover rect.child {
        fill: #bbb;
      }

      form {
        padding: 0;
        display: inline-block;
      }

      .flex-container {
  display: flex;
  flex-direction: row;
  flex-wrap: nowrap;
  justify-content: normal;
  align-items: normal;
  align-content: normal;
}

.flex-items:nth-child(1) {
  display: block;
  flex-grow: 1;
  flex-shrink: 1;
  flex-basis: auto;
  align-self: auto;
  order: 0;
}

.flex-items:nth-child(2) {
  display: block;
  flex-grow: 0;
  flex-shrink: 1;
  flex-basis: auto;
  align-self: auto;
  order: 0;
}
    </style>
  </head>

  <body
    id="drop_zone"
    ondrop="dropHandler(event);"
    ondragover="dragOverHandler(event);"
    >
    {% if org %}
      <p><a href='https://github.com/{{org}}/{{repo}}/pull/{{number}}'>{{org}}/{{repo}}#{{number}}</a></p>
    {% endif %}
   <div class="flex-container">
   <div class="flex-items">
    <form>
      <select name="A" id="sZ">
        <option value="name" selected>Report File</option>
        <option value="key">Test Path</option>
        <option value="group">test[...]</option>
        <option value="param">...[param]</option>
        <option value="kind">Setup/Call/Teardown</option>
        <option value="rollup">-</option>
      </select>
      <select name="A" id="sA">
        <option value="name">Report File</option>
        <option value="key" selected>Test Path</option>
        <option value="group">test[...]</option>
        <option value="param">...[param]</option>
        <option value="kind">Setup/Call/Teardown</option>
        <option value="rollup">-</option>
      </select>

      <select name="B" id="sB">
        <option value="name">Report File</option>
        <option value="key">Test Path</option>
        <option value="group" selected>test[...]</option>
        <option value="param">...[param]</option>
        <option value="kind">Setup/Call/Teardown</option>
        <option value="rollup">-</option>
      </select>

      <select name="C" id="sC">
        <option value="name">Report File</option>
        <option value="key">Test Path</option>
        <option value="group">test[...]</option>
        <option value="param" selected>...[param]</option>
        <option value="kind">Setup/Call/Teardown</option>
        <option value="rollup">-</option>
      </select>

      <select name="D" id="sD">
        <option value="name">Report File</option>
        <option value="key">Test Path</option>
        <option value="group">test[...]</option>
        <option value="param" >...[param]</option>
        <option value="kind" selected>Setup/Call/Teardown</option>
        <option value="rollup" >-</option>
      </select>
     </form>
    </div flex-items> 
    <div class="flex-items">
      <div id='infowrap'><span id='info'>...</span></div>
    </div>
    </div>
    <div id='busy'><div>

    <!--| Layout
    <select name="layout" id="layout">
        <option value="treemapBinary">Binary</option>
        <option value="treemapDice">Dice</option>
        <option value="treemapSlice">Slice</option>
        <option value="treemapSliceDice">SliceDice</option>
        <option value="treemapSquarify">Squarify</option>
    </select>-->

    <div id="chart"></div>
    <content>
      <p id="tip">
        Drag pytest json report files and select the you decomposition you like
        above.
      </p>
      <p>
        You can generate report with
        <code>pytest --json-report --json-report-file=report.json</code>
      </p>
    </content>

    <footer>
        <p style='float:left;'>Author: Matthias Bussonnier</p>
        <p style='float:right;'>GitHub: <a href='https://github.com/Carreau/pytest-json-report-viewer'>Carreau/pytest-json-report-viewer</a></p>
    </footer>

    <script src="//code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="/index.js"></script>
    <script>

    function handle_test_data(dx){
        window.DX = [];
        for (const property in dx) {
            console.log(`${property}: ${dx[property]}`);
            window.DX = window.DX.concat(process_reply(dx[property], property));
        }
        console.info(window.dx);
        window.init();
    }
    console.log('HERE')
    fetch('/api/gh/{{org}}/{{repo}}/pull/{{number}}')
      .then(
        function(resp){
              return res;
        })
        .then(handle_test_data)

                            )

    </script>
    <script>
      var source = new EventSource('/sse-endpoint');
      console.log('Source started')
      const info = document.getElementById('info');
      source.onmessage = function (event) {
       console.log('event', event.data);
      };
      source.addEventListener('message', function(event) {
        data = JSON.parse(event.data);
        info.innerText = data.info;
        console.log('Message occurred:', data, 'event', event, 'id:', id, 'retry:', info, 'full event', event);
      });
      source.addEventListener('error', function(event) {
        // Handle 'error' events
        console.error('Error occurred:', event);
      });

      eventSource.addEventListener('open', function(event) {
        // Handle 'open' events
        console.log('Connection opened');
      });

      eventSource.addEventListener('close', function(event) {
        // Handle 'close' events
        console.log('Connection closed');
      });
    </script>
  </body>
</html>
